#!/bin/bash

gen_text_widget()
{
cat <<EOF
                <text use-markup="true" justify="2" space-expand="true" space-fill="true" wrap="true" width-chars="40">
                        <label>"$1"</label>
                </text>
EOF
}

net_progress() {
	for i in $(seq 99 -10 0); do
		if [ -z "`ipconfig |grep -e 'inet addr' |grep -v 127.0`" ]; then
			echo $i
			[ "$i" -le 10 ] && echo "One"
	                [ "$i" -le 20 -a "$i" -gt 10 ] && echo "Two"
	                [ "$i" -le 30 -a "$i" -gt 20 ] && echo "Three"
	                [ "$i" -le 40 -a "$i" -gt 30 ] && echo "Four"
	                [ "$i" -le 50 -a "$i" -gt 40 ] && echo "Five"
	                [ "$i" -le 60 -a "$i" -gt 50 ] && echo "Six"
	                [ "$i" -le 70 -a "$i" -gt 60 ] && echo "Seven"
	                [ "$i" -le 80 -a "$i" -gt 70 ] && echo "Eight"
			[ "$i" -le 90 -a "$i" -gt 80 ] && echo "Nine"
			[ "$i" -gt 90 ] && echo "Ten"
			sleep 1
		fi
	done
	echo 100 Done
}; export -f net_progress

x_error()
{
title="$1"
shift
while [ -n "$1" ]; do
        local text_widget="$text_widget `gen_text_widget \"$1\"`"
        shift
done
        export MAIN_DIALOG='
<window title="'$title'" decorated="false" resizable="false">
        <vbox>
                <hseparator></hseparator>
                <hbox>
                        <pixmap icon_size="6">
                                <input file stock="gtk-dialog-error" has-focus="true"></input>
                        </pixmap>
                        <vbox>
                                '$text_widget'
                                <vseparator height-request="5"></vseparator>
                        </vbox>
                </hbox>
                <hseparator></hseparator>
                <hbox>
                        <button has-focus="false" can-focus="false">
                                <label>"Exit"</label>
                                <action>EXIT:ok</action>
                        </button>
                </hbox>
        </vbox>
</window>
'
        result=`$GTKDIALOG`
        exit 1
}

export BAR_DIALOG='
<window title="Kiosk Progress" decorated="false" width-request="325" height-request="100" allow-grow="false" allow-shrink="false" skip_taskbar_hint="true">
	<vbox>
		<text>
			<label>Waiting for '$Pkg' network.</label>
		</text>
		<vseparator height-request="5"></vseparator>
		<progressbar>
			<variable>PROGRESS_BAR</variable>
			<label>Some Text</label>
			<input>bash -c net_progress</input>
			<action function="refresh">ENTRY</action>
			<action function="closewindow">BAR_DIALOG</action>
			<action>echo ready</action>
		</progressbar>
	</vbox>
	<variable>BAR_DIALOG</variable>
</window>
'

find_network()
{
	[ -z $GTKDIALOG ] && GTKDIALOG=gtkdialog
	Pkg=$1

#	if [ -z "`ifconfig |grep -e 'inet addr' |grep -v 127.0`" ]; then
		$GTKDIALOG --program=BAR_DIALOG
#	fi
	if [ -z "`ifconfig |grep -e 'inet addr' |grep -v 127.0`" ]; then
		x_error "Network" "Timed out waiting for network!"
		return 1
	fi
}

find_network $@
